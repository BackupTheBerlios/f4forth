( ========== < F4 local memory hi-level extension > ========== )                                                                                      We 2002-11-20 05:16                                                                                                            f4a@lxhp.in-berlin.de                                                                                       hi-level substitute, example to a local memory implementation   for fig-style forth systems which provide the user-vari "s0".   no other requirements. - non-commercial QT-License applies.                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( ========== < F4 local memory hi-level extension > ========== )                            6 load ;s                                                                                                                                                                                 We 2002-11-20 05:16                                                                                                            f4a@lxhp.in-berlin.de                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( ========== < F4 local memory hi-level extension > ========== )\                                                               \ F4 local 'variables' based on unlimited size local memory     \ allocation, by cells addressable w. 'l@' and 'l!' or, by the  \ content of uvari s0 prior to allocation as the local memory   \ base address - F4: re "l0" user-constant in 'local' voc.      \ this locals implementation for simplicity, doesn't provide    \ addressing by names but, indexed by cells' positions access.  \ e.g.                                                          \       1 l@ 3 l!                                               \ copies 1st to 3rd local cell.                                 \                                                               \ local memory can be preserved across forth words.             \ this impl. might not be the most (though fairly) efficient one\ but, was supplied as an example of some hi-level words which  \ could extend #any# forth which provides the "s0" uvari.       ( ========== < F4 local memory hi-level extension > ========== )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( ========== < F4 local memory hi-level extension > ========== )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( ========== < F4 local memory hi-level extension > ========== )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( == dstack == : ndrop : ;s : exit : -exit )                    forth definitions decimal                                                                                                       s0 @ constant max-s0         ( locals ptr 'underflow' control )                                                                 \ {;s} and {exit}, define as required: in fig-forth,            \ {;s} is aequivalent to {exit} and, aequivalent to { r> drop }                                                                 \ -exit         ( flg -- )      ( exit if flg =/= 0 )           : -exit [compile] if compile ;s [compile] endif ;   immediate                                                                   : ndrop dup 0< if minus 0 do 0 loop ;s endif                      depth 1- min 0max -dup 0= -exit 0 do drop loop ;                                                                      -->                                                                                                                                     ( == dstack == : +roll : +pick : -roll : -pick                  forth definitions decimal                                                                                                       : +roll 1- dup 0< if drop ;s endif                                dup begin rot >r 1- dup 0< until drop                           begin r> rot rot 1- dup 0< until drop ;                                                                                       : -roll minus dup dup do 0 do j roll loop leave loop ;                                                                          : +pick 1- dup 0< if drop ;s endif                                dup begin rot >r 1- dup 0< until drop over swap                 begin r> rot rot 1- dup 0< until drop ;                                                                                       : -pick swap >r dup >r abs +roll drop r> r> swap +roll ;                                                                -->                                                                     ( : roll : pick                  ( 'backwards' w. -ve indices ) forth definitions decimal                                                                                                       : roll                                                            dup 0< if -roll ;s endif +roll ;                                                                                              : pick                                                            dup 0< if -pik ;s endif +pick ;                                                                                       -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (  : :locals : locals; : >loc : loc> : -loc : (locals : locals) forth definitions decimal                                                                                                       : -loc -dup 0=          ( +/-bytes -- cells +/-aligned sign   )   if r> drop exit endif                                           >rr abs 3 + -4 and r> +- dup dup >r abs 4/ swap r> 0< ;                                                                                                                          -->                                                                                                                                                                                                                                                                                                                                                                                                          \ -loc          ( +/-bytes -- cells +/-aligned sign )           \   prepare parameters for 'local's de-/allocation.             ( ==== de-/allocate local memory ==============   >loc   loc> ) forth definitions decimal                                                                                                       : >loc 4* -loc 3 ?error >r         ( n -- ( alloc local cells )   0 do 0 depth 1- minus roll loop r> s0 +! ;                                                                                    : loc> 4* minus -loc 0= 3 ?error   ( n -- ( de-alloc locals   )   s0 +! >rr 0 do depth 1- roll loop r> ndrop ;                                                                                                                                             -->                                                                                                                                                                                                                                                                  \ >loc          ( n -- )        allocate n local cells          \ loc>          ( n -- )        de-allocate n local cells       ( ==== de-/allocate local memory ===================== : |loc ) forth definitions decimal                                                                                                       : |loc          ( n -- a )                                        s0 @ >r dup 0<                                                  if >r r minus loc> r> r> + max-s0 max ;s endif >loc r> ;                                        ( ^^^ re below )                                                                      -->                                                                     \ |loc          ( n -- a )                                      \   allocate +n, de-allocate -n local cells,                    \   ret ptr to local memory before allocation, after de-alloc.  \   further, system dependent control required to preventing the\   locals pointer taking a value 'above' absolute dstack top.  \   this impl. {max} is due to F4 specific +ve stack growth.    \   use {min}, instead, for a more 'normal' implementation...   ( ==== local variables ================== : :locals : locals; ) forth definitions decimal                                                                                                       : :locals |loc dup 0 l! -dup 0= -exit 1 do i l! loop ;                                                                          : locals; minus |loc ;                                                                                                  -->                                                                                                                                                                                                                                                                     \ :locals       ( n -- )                                        \   alloc & init top +n local cells from dstack                 \   top local item at index 0, @tos before allocation.          \ locals;       ( n -- )                                        \   discard top n cells of local datapace                       ( ==== local variables ============================ : l@ : l! ) forth definitions decimal                                                                                                       : l@ depth + pick ;                                             : l! depth + 1- minus pick ;                                                                                                                                                               -->                                                                                                                                  \                                                               \ l@            ( n --x )                                       \   fetch n-th local, n=0 is 1st                                \ l!            ( x n -- )                                      \   store x to n-th local                                       \   l@, l! don't require the rsp. locals defined in current word\   & may refer to any levels' local memory, in the actual order( ==== local variables ====================== (locals   locals) forth definitions decimal                                                                                                       : (locals 1+ dup :locals ; ( n -- )                             : locals)  0 l@  locals; ; ( - -- )                                                                                                                                                     -->                                                                                                                                                                                                     \ (locals       ( n -- )                                        \   initiate n local cells from dstack                          \ locals)       ( - -- )                                        \   de-alloc latest by '(locals' installed local cells          \   top local item at index 1, @tos before allocation.          \   size by above words stored to/fetched from posn 0.          ( == link local memory back == : no-loc : l0 : use-loc )        forth definitions decimal                                                                                                       : l0 s0 @ ;                 ( fetch & save BEFORE allocation! )                                                                 : no-loc                    ( init empty dstack )                 max-s0 dup s0 ! ;                                                                                                     -->                                 ( specific to F4 mmap-ed dstack,  ) : use-loc 8+ +sp drop ;     ( obsoleted by kernel word {|loc} )                                                         -->     \ use-loc       ( n -- )                        forth           \   assure non-relocating availabilty of n local cells. blocks  \   of local work-space relocation prevented by trial allocation\   of expected size. locals base ptr may change w. allocation  \   beyond size of stack section less minimal dstack margin.    ( ========== < F4 local memory hi-level extension > ========== )                                                                                                                                                ;s                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              