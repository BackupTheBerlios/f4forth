--> ************** ANS-FORTH compliance for F4 ************* <--              mailto: f4 -at- lxhp . in-berlin . de                                                                                                F4 ANS-word are not tested!                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        6 b/scr * 1+ blk ! 0 in !                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 --> ************** ANS-FORTH compliance for F4 ************* <--              mailto: f4 -at- lxhp . in-berlin . de                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             NOT IMPLEMENTED                                                 EMPTY STACK                                                     DICTIONARY FULL                                                 HAS INCORRECT ADDRESS MODE                                      ISN'T UNIQUE                                                                                                                    DISC RANGE ?                                                    FULL STACK                                                      DISC ERROR !                                                                                                                                                                                                                                                                                                                                                                                                                                                    FORTH INTEREST GROUP     ( F4 hp - SEP/2002 )        MAY 1, 1979(  ERROR MESSAGES  ) -->                                        COMPILATION ONLY, USE IN DEFINITION                             EXECUTION ONLY                                                  CONDITIONALS NOT PAIRED                                         DEFINITION NOT FINISHED                                         IN PROTECTED DICTIONARY                                         USE ONLY WHEN LOADING                                           OFF CURRENT EDITING SCREEN                                      DECLARE VOCABULARY                                                                                                                                                                                                                                                                                                                                                                                                                                              FORTH INTEREST GROUP     ( F4 hp - SEP/2002 )        MAY 1, 1979( **************** ANS-FORTH compliance for F4 *************** )lc-ignore          ( NOTE: '-?-' marked words not, 'ok' tested )( 'capitals' may be good for some rather antique u.s-ANS style )( terminals but, bad for reading, thus I use small letters...  )                                                                forth definitions           if-found xlload 2 +continue         : xlload       ( ccc --,load word ccc from main library file )    ?exec [ libdir count + 1+ ] literal name l-load drop ;                                                                        xlload !hlp                                                     if-nfound f" xlload f"  ( also loads place, +place, c+place   ) if-nfound place xlload place                                    hlp!                                                                                                                    -->                                                                                                                                     ( ANS-FORTH compliance: F4/fig-4th specific                   )                                                                 vocabulary ans immediate 2nd-voc ans forth ans definitions                                                                      : palias        ( ccc, pfa -- ( synonym of a primitive, only! )   create unsmudge cfa @ latest pfa cfa ! ;                                                                                      : >flag 0= 1- ;  ( n -- f ( translate to ANS-type flag value  )                                                                                                                                                                                         -->                                                                                                                                                                                                                                                                                                                                     ans definitions ( CORE: ['] ' 2! 2@ >in <>                    )                                                                 : ['] forth [_] ' ;     immediate      ( ccc -- ( cpl cfa ccc )                                                                 in (up) - user >in                                                                                                              : <> = 1- ;                            ( n1 n2 -- flg         )                                                         -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ans definitions ( CORE: >number ?dup abort"                   )                                                                 : >number       ( dn p u -- dn' p u' )                            2>rr here >rr place r (number) r> - 2r> rot /string ;                                                                         ' -dup palias ?dup      \ : ?dup -dup ;                                                                                         if-nfound abort" xlload abort"                                                                                                  : base>         ( p u -- b p' u' )                                2>rr here >rr place r a-base swap r> - 2r> rot /string ;      \ either, extract base from string praefix or, ret @base figure                                                                                                                     -->                                                                                                                                         (    accept align aligned cell+ cells char+ chars char [char] ) ans definitions                                                 : accept        ( p u -- u' )                                     dup 4+ dup 4+ 4/ dup |loc minus >r l0 swap erase                l0 swap expect l0 zcount >rr rot swap cmove r> r> |loc ;                                                                      : aligned dup 3 and -dup 0= -exit 4- - ;                        : align dp @ aligned dp ! ;                                                                                                     ' 4+ palias cell+           if-nfound cells ' 4* palias cells   ' 1+ palias char+           if-nfound chars : chars ;                                                                           ' ascii palias char                                             ' ascii palias [char]       immediate \ : [char] [_] ascii ;                                                            -->                                                                     ans definitions ( CORE: create )                                                                                                ( def'd at eof )                                                                                                        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ans definitions ( CORE: environment? ?environment )                                                                             vocabulary environment 2nd-voc environment ans                                                                                  : environment?      ( p u -- .xx. tf | ff )                       dup 8+ 4/ dup |loc minus >r l0 place                            context @ >r environment                                        l0 sfind dup if 2drop cfa execute 1 endif                       r> context ! r> |loc ;                                                                                                        : ?environment context @ environment vlist cr context ! ;                                                                                                                               -->                                                                                                                                                                                                     ans definitions ( CORE: evaluate find )                                                                                         xlload? evaluate                                                : evaluate eval ;                                                                                                               hidden definitions          ( also for {search-wordlist} )      : fdf dup 0= -exit drop     ( convert flags from -find )          [ latest c@ immediate latest c@ immediate xor ] literal         and 0= 0= 2* 1- ;                                                                                                             ans definitions                                                 : find -find fdf ;          ( a -- 0 | imed-pfa 1 | pfa -1 )                                                            -->                                                                                                                                                                                                     ans definitions ( CORE: fm/mod )                                                                                                : fm/mod        ( d1 n2 -- n3 n4 )                      ( ok)     dup >r dup 0< if minus >r dminus r> endif                       over       0< if sover + swap endif                             m/mod drop r> 0< if swap minus swap endif ;                                                                                                                                           -->     .( test {fm/mod:)                                               : tt 2 pick 2 pick 4 d.r ." /" dup 4 .r fm/mod                    2dup 4 .r "q emit 4 .r "r emit tab                              d- or if ." -?-" else ." ok" endif cr ;     cr                 3  1  10.  7  tt         4 -2 -10.  7 tt                       -4 -2  10. -7  tt        -3  1 -10. -7 tt     forget tt                                                                                                                                         (    invert lshift negate postpone r@ recurse rshift s>d sign ) ans definitions                                                                                                                 ' not           palias invert                                   ' <<            palias lshift                                   ' minus         palias negate                                   ' [_]           palias postpone         immediate               ' r             palias r@                                       ' >>            palias rshift                                   ' s->d          palias s>d                                                                                                      : recurse last @ pfa cfa , 0 cmc ! ;    immediate                                                                       -->                                                                                                                                                                                                     ans definitions ( sm/rem then um* um/mod unloop variable word )                                                                 ' endif         palias then         immediate                   ' 2rdrop        palias unloop                                                                                                   : sm/rem md/mod drop ;                                          : um* 0 swap udm* ;                                             : um/mod m/mod drop ;                                                                                                   -->         ( variable, word follow at eof )                                                                                            \ CORE ends                                                                                                                                                                                                                                                                                                                     ans definitions ( CORE-EXT: #tib 0<> 0> 2>r 2r> 2r :noname    )                                                                 0 variable #tib                                                 : #tib #tib tib @ zcount sdrop over ! ;                         : 0<> 0= 0= ;       ( obtain ANS-flag value { : 0<> >flag ; } ) : 0> 1- 0< 0= ;                                                                                                                 : :noname       ( -- cfa )                                        smudge               ( compensate other {smudge} by semis )     align here !csp [ ' task cfa @ ] literal , ] ;                ( in case of an error leaves the {latest} word smudged! )                                                               -->                                                                                                                                                                                                                                                                     ( <> ?do case of endof endcase compile, convert span expect   ) ans definitions                                                                                                                 if-nfound ?do xlload ?do                                        ' "             palias c"       immediate                                                                                       forth definitions if-nfound cmc0 : cmc0 0 cmc ! ;               ans definitions                                                 if-nfound endcase xlload endcase ( eaker's CASE )                                                                               : compile, cfa , ;                                              ' (number)      palias convert                                  0 variable span                 ( expect follows at eof )                                                                                                                               -->                                                                     ans definitions ( CORE-EXT: false true marker nip parse )                                                                       ' 0              palias false                                   false 0=       constant true ( fig-4th! use {>flag} for ANS )   if-nfound marker xlload marker                                  ' sdrop          palias nip                                                                                                     : parse         ( c -- p u )                                      >r source in @ /string 2dup r> scan sdrop - dup 1+ in +! ;                                                                                                                            -->                                                                                                                                                                                                                                                                                                                                     ans definitions decimal ( CORE-EXT: refill )                                                                                    : refill        ( -- )                                            (bits) @ 132 and 0= dup 0= -exit drop    ( evaluate, script )   blk@ -dup 0= if [ok] query 1 exit endif >rr 0<  ( terminal  )   if tib @ 256 10 dr1c chan fread r> over 0<                       if 2drop 0and exit endif not + not blk ! 1or   ( {chain}ed )   else r> 1+ dup blk ! block drop                 ( blockfile )    dr? bchan ch-rnum 0< 0=                                        endif 0in! ;                                                                                                          -->     \ {refill} cannot be substituted with fig-4th <nul> procedure   \ because of implied return to previous level caller:           : x blk @ -dup                                                      if 1+ dup blk ! b/scr 1- and -exit ?exec endif r> drop ;    : refill [x] source sdrop 1- 0< 0= ;        ( -?- )     -->     hidden definitions ( CORE-EXT: restore-input )                                                                                  0 constant #ci                  ( cons # of saved cells )       : ci >rr ch-id r> cdt ;         ( chan -- chid addr )           : ca dup @ swap ;               ( addr -- n addr )                                                                              ans definitions                                                 : restore-input                 ( -?-, ok but w. <n.i.> error )   dup #ci - 3 ?error >r         ( amode error if false #items )   dr! chp 1+ 2! chp c!          ( rst screenfile&chan's reloc )   r> 4- 2/ 0 do ! loop ;        ( re-store variables          )                                                                                                                     -->                                                                         \ restore-input:                                                \ re {save-input} for which items saved, vari's list extendable ans definitions ( CORE-EXT: save-input )                                                                                        : save-input depth >r   ( -- .xx. n )                             stdin ci stdout ci stderr ci  ( standard channels )             prt ci kbd ci                 ( 2nd-ary i/o, keyboard )         dr? >rr bchan ci              ( screenfile channel + id     )   in ca blk ca scr ca tib ca    ( i/o description             )   context ca current ca         ( vocabularies                )   base ca (bits) ca state ca    ( i/o state                   ) \  NOTE: use {si}, {sa} to extending above list w.o. limits or, \        remove any such unwanted items but, keep the {dr?} line  chp c@ chp 1+ 2@              ( relocation indices          )   r> depth r> - ;               ( bchan, # of saved cells     )                                                                 save-input dup to #ci ndrop                                                                                         -->         ans definitions ( CORE-EXT: source-id tuck u.r u>             )                                                                 : source-id     ( -- flag|channel ( -?- )                         -1 (bits) @ 132 and -exit drop        ( evaluate, script )      blk@ dup 0= -exit                     ( stdin/terminal input)   dup 0< if drop dr1c chan exit endif                             1- 0< 0= if dr? bchan exit endif -1 ;                                                                                         ' sover         palias tuck                                     : u.r 0 swap d.r ;                                              : u> swap u< ;                                                                                                      -->         \ source-id:  if blk @ = 0 and chp c@ = 0, input is stdin       \   if stdin: if channel-id 0, input is linux-stdin, else file; \   linux-stdin may be ANY redirected type or, keyboard/terminal\   check uvari (bits) for the particular execution mode.       ans definitions ( CORE-EXT: unused value within unused        )                                                                 : unused (db) @+ swap @ + here - 4/ ;                                                                                           ' constant      palias value                                                                                                    (     dpans94 wartet mit derart verquaster beschreibung auf,  ) (     daß einfach das dort gegebene beispiel herhalten muß:   ) : within OVER- >R - R> U< ;                ( test lo hi -- flg )                                                                                                                        -->     \ CORE-EXT ends                                                                                                                                                                                 \ für within soll(te) gelten:                                   \ ( t l h -- f ) mit tf bei l \< t < h, mit oder ohne vorzeichenans definitions ( DOUBLE: d0< d0= d22* d2/ d< d= d>s dmax dmin)                                                                 : d0< sdrop 0< ;                                                : d0= or 0= ;                                                   : d2* 2dup d+ ;                                                 : d2/ 1 2>> ;                                                   : d< d- d0< ;                                                   : d= d- d0= ;                                                   ' drop palias d>s                                               : dmax 2over 2over d< if 2swap endif 2drop ;                    : dmin 2over 2over d< 0= if 2swap endif 2drop ;                                                                                                                                         -->                                                                                                                                                                                                     ans definitions ( DOUBLE: dnegate                             )                                                                 ' dminus palias dnegate                                                                                                                                                                                                                                 -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ans definitions ( DOUBLE-EXT: 2rot du<                        )                                                                 : 2rot 5 roll 5 roll ;      \ : 2rot 2>r 2swap 2r> 2swap ;                                                                      : du< rot swap 2dup =/=                                           if 2swap 2drop u< exit endif 2drop u< ;                                                                               -->                                                                                                                                     cr if-nfound ud. : ud. <# bl hold #s #> type ;                   -10.00000005  10.00000005 4 ndup du< . 2swap d. d. cr            10.00000005 -10.00000005 4 ndup du< . 2swap d. d. cr           -10.00000005 -10.00000005 4 ndup du< . 2swap d. d. cr            10.00000005  10.00000005 4 ndup du< . 2swap d. d. cr            10.00000005  10.00000006 4 ndup du< . 2swap d. d. cr            11.00000005  10.00000005 4 ndup du< . 2swap d. d. cr          ans definitions ( FACILITY: key? page                         )                                                                 ' ?terminal palias key?                                                                                                         : out-id stdout chp + c@ ch-id ;                                                                                                : page out-id cons?                                               if s" \e[2J\e[H" here e\stg type else 12 emit endif 0 out ! ;                                                                                                                         -->                                                                                                                                                                                                                                                                                                                                                                                                     ans definitions ( FACILITY-EXT: ekey ekey>char ekey? emit? ms )                                                                 ' key           palias ekey                                     ' key>char      palias ekey>char                                ' ?terminal     palias ekey?                                    : emit?                                                           0 1 here out-id over ! 4 over 4+ ! sp@ sys poll                 >r 4 ndrop r> 1- 0< 0= ;                                      : ms 1000000 u* 1000000000 u/mod swap                             sp@ 4- 0. sp@ 4- 3 pick sp@ sys nanosleep 9 ndrop ;                                                                   -->                                                                                                                                     \ syscall <poll>:                                               \ int poll(struct pollfd *ufds, unsigned int nfds, int timeout) \     sp@         here              1                  0        ( FACILITY-EXT : >time&date : date )                            hidden definitions                   if-found date 1 +continue  : date 0 sp@ sys time sdrop sdrop ; ( sec. since 1.1.1970 00h )                                            -wl date if-true ;s                                                 if-found dy -->  0 variable dy -4 vallot                                         31 cv, 28 cv, 31 cv, 30 cv, 31 cv, 30 cv,                       31 cv, 31 cv, 30 cv, 31 cv, 30 cv, 31 cv, 365 cv,               31 cv, 29 cv, 31 cv, 30 cv, 31 cv, 30 cv,                       31 cv, 31 cv, 30 cv, 31 cv, 30 cv, 31 cv, 366 cv,               range: dyr  00 31 59 90 120 151 181 212 243 273 304 334 365 ;   case:  dyc 00 00 31 59 90 120 151 181 212 243 273 304 334 365 ;                                                           -->                                                                   \ NOTE: use v, and cv, instead of , or c, when referring        \       to a data array by the address of a variable.            ( FACILITY-EXT: >time&date       :ALT: -reserve-             )    hidden definitions         if-found >time&date 12 +continue                                                                  : >time&date         ( n -- year month day hour minute second )   0 60 m/mod 60 m/mod 24 m/mod          ( sec min days d.rmd  )   2dup 730. d- 1461 m/mod         ( 1968; div 4 years + 1 day )   rot >r d- 365 m/mod drop 1970 +       ( leap days flg, year )   sdup dyr dup -rot dyc - swap r> 0=    ( -- s i h y d m      )   if dup 2 < 0=                         ( adjust on leap year )    if swap 1+ sdup dy + 11 + c@ over >                              if 1+ swap 2- swap endif                                      endif endif rot ;                                                                                                                                               -wl >time&date 0= if-true -->                                                                                                                                  ( FACILITY-EXT ( : day : >day : "day : .day                  )    hidden definitions                              lload date                                         if-found da 2 +continue   0 variable da -4 vallot                                         "oD wv, "rF wv, "aS wv, "oS wv, "oM wv, "iD wv, "iM wv,                                                                         if-nfound >day : >day [ 60 60 24 * * ] literal / 7 mod ;        if-nfound "day : "day >day 2* da + 2 ;                          if-nfound day  : day date "day ;                                if-nfound .day : .day day type ;                                                                                                           -wl .day -l day or -l !day or -l >day or if-true ;s                                                             -->                                                                                                                                                                                                   ( FACILITY-EXT : time&date                                   ) forth definitions if-found ans ans definitions                                                                                  lload date                                                      lload >time&date                                                if-nfound time&date : time&date date >time&date ;                                                     -wl time&date if-true ;s                                                             -->    -wl .day -l day or -l !day or -l >day or -l .. or if-true ;s                                                                                                                                                                                                                                                                                                                                  \ time&date ( -- s m h D M Y )                                  \   ret current Y:ear, M:onth#, D:ay#, h:or, m:inute, s:econd    ( additionally: ============ : .t&d : ..                     )                                                                                        -l .. -l .t&d or 0= if-true 1 +continue  if-nfound ..  : .. >r 0 <# # #s r> -dup if hold endif #> type ;                                              -wl .. if-true ;s                                                                                          lload .day   if-found .t&d 2 +continue  : .t&d base@ decimal .day time&date                               rot bl .. swap ". .. ". .. bl .. ": .. ": .. base ! ;                                                    -wl .t&d if-true ;s                                                             -->                                                                                                                                                                                                                                                                  \ .t&d output example: "Do 16.01.2003 03:46:02"                  ( additionally: ============ : "t&d : .t&d ( 2nd-ary defn    )                                    -l ans -l f4 or if-true -->                                       if-found >t&d 6 +continue                              lload time&date lload day           : >t&d base@ >r decimal >time&date   ( n -- aa.mm.dd hh:mm:ss )   <# 5 roll 0 # #s 2drop ": hold 4 roll 0 # #s 2drop ": hold         3 roll 0 # #s  drop bl hold          # #s  drop ". hold                    #s  drop ". hold            #s       bl hold         day drop c@+ swap c@ hold hold #> r> base ! ;                                                                              if-nfound "t&d      : "t&d date >t&d ; ( -- aa.mm.dd hh:mm:ss ) -wl .t&d if-true if-nfound .t&d  : .t&d "t&d type ;                                                                             \ >t&d  ( date -- p u )                                         \   example Di 4.3.2003 00:32:26; {"t&d} for the editor, f4e.scr\   ret datumstext "tag tag.monat.jahr std:min:sec"             ( FILE: bin close-file create-file open-file delete-file      ) ans definitions                                                                                                                 : bin ;         immediate ( ..oder nicht, blödsinn jedenfalls ) ' close palias close-file                                       : open-file 4K +sp drop over 8+ 4/ >rr |loc >r l0 place           l0 r> new-chan open r> minus |loc dup 1- dup 0< -exit 0and ;  : create-file cre open-file ;                                   : delete-file                                           ( ok)     4K +sp dropd 8+ 4/ >rr |loc l0 place                            l0 scount drop sp@ sys unlink sdrop sdrop r> minus |loc ;                                                                                                                             -->                                                                                                                                                                                                     ans definitions ( FILE: file-position file-size )                                                                               xlload <fpos> xlload <fsiz>                                                                                                     : file-position                                                   0 over fposre dup 0< -exit drop cdt <fpos> 2@ 0 ;             : file-size                                                       dup ch-id dup 0< -exit drop cdt <fsiz> 2@ 0 ;                                                                                                                                         -->                                                                                                                                                                                                                                                                                                                                                                                                     ans definitions ( FILE: include-file include r/w )                                                                              ' chain palias include-file                 ( chan -- )         : included r/o open-file -exit chain ;      ( p u -- )                                                                                                                                                                                                          ( r/w follows at eof )                                                                                                  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( FILE: read-file read-line reposition-file resize-file      ) ans definitions                                                                                                                 hidden definitions                                              : rfl fread sdrop dup dup 0< minus and ;                                                                                        ans definitions                                                 : read-file  -1 rfl ;                                           : read-line #10 rfl ;                                                                                                           xlload fpos                                                     : reposition-file fpos drop 0< ;    ( tf on error )             : resize-file                                                     ch-id sp@ sys ftruncate 2swap 2drop sdrop ;                                                                           -->                                                                     ans definitions ( FILE: source-id write-file write-line       )                                                                 : source-id                                                       (bits) @ 128 and if -1 exit endif     ( 'evaluate' )            dr? bchan blk @ -exit drop            ( 'load'ing )             (bits) @ 4 and if chmax 1- exit endif ( script-file dr1-ch )    stdin chan ;                          ( stdin, {chain}ed )                                                                    hidden definitions                                              : wfl fwrite dup 0< minus and ;                                 ans definitions                                                 : write-file  -1 wfl ;                                          : write-line #10 wfl ;                                                                                                  -->                                                                                                                                     ans definitions ( FILE-EXT: file-status flush-file )                                                                            \ very diffuse words about what a 'file status' should be, in   \ 'the' standard. this impl. returns permission bits from       \ <st_mode> field of linux syscall stat struct:                 : file-status                                                     4K dup |loc minus >r l0 place                                   l0 scount 2dup + sdrop swap sp@ sys stat >r drop sdrop          r r> 0< 0= if drop 8+ w@ endif r> |loc ;                                                                                      : flush-file    ( ch -- er )                                      dup ch-id dup not 0= if 2drop -2 exit endif ( chan not used )   0< if msync exit endif                 ( chan may be mmap-ed)   sp@ sys fdatasync sdrop ;                                                                                             -->                                                                     ans definitions ( FILE-EXT: rename-file )                                                                                       : rename-file                                                     8K dup |loc minus >r l0 place l0 4K + place                     l0 4K + scount drop l0 scount drop sp@ sys rename               >r drop 2drop r> r> |loc ;                                                                                    -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ans definitions ( MEMORY-ALLOC: allocate free resize )                                                                          forth linux definitions ( -- pid, current process id )          : pid@ sp@ sys getpid sdrop ;                                                                                                   forth hidden definitions ( adr -- adr' sz | -22 & early exit )  : ohp 8- dup @+ pid@ = if @ exit endif 2drop rdrop -22 ;                                                                                                                                -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ans definitions ( MEMORY-ALLOC: allocate free resize )                                                                          \ ( size -- addr er ) [ owner-pid ][ size ]addr[ ..(mem).. ]    \ minimal address verification by stored process id             : allocate                                                        8+ mmapa dup ermax u< if pid@ swap !+ !+ 0 exit endif dup ;                                                                   : free ohp swap munmap ;                                                                                                        : resize ( adr new-size -- new-adr er, data preserving! )         >r ohp over swap r mremap r> over ermax u<                      if over 4+ ! 0 exit endif dropd ;                                                                                                                                                     -->                                                                     \ MEMORY-ALLOC ends, ANS defines no EXT words )                  ( SEARCH-ORDER: forth-wl get/set-current search-wl order     ) ans definitions                                                                                                                 forth context @ constant forth-wordlist                         : get-current current @ ;                                       : search-wordlist                                                 4K dup |loc minus >r >r l0 place                                l0 r> @ (find) fdf r> |loc ;                                  : set-current current ! ;                                                                                                       \ 0 constant SEARCH-ORDER-EXT - not applicable to F4 search ordrxlload order                                                    xlload vocs                                                                                                             -->                                                                                                                                     ans definitions ( STRING: blank match compare )                                                                                 ' blanks        palias blank                                    ' s=            palias compare                                  : search match over 0= 0= ;                                     : sliteral state@ 0= -exit                                        ' (") cfa , dup c, here over allot 0 c, swap cmove ; immediate                                                                                                                        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ans definitions ( TOOLS: words )                                                                                                ' vlist palias words                                                                                                                                                                -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ans definitions ( TOOLS-EXT: ahead code cs-pick cs-roll       )                                                                 ' create palias code                                            : ahead here 0 , ;                      immediate               : 2pick 2* s->d 2* 1+ + >rr pick r> pick ;  ( +/- pick/store  ) : 2roll 2* s->d 2* 1+ + >rr roll r> roll ;  ( +/- roll          : cs-pick 2pick ;                                               : cs-roll 2roll ;                                                                                                                                                           -->                                                                                                                                                                                                                                                                                                                                                 \ 2pick/roll may be used w. -ve indices as the rsp sing F4 wordsans definitions ( TOOLS-EXT : [else] : [if] : [then] [endif]  )                                                                 : [else] 1 begin                            ( -?-( 'testif' ok)    begin name count over c@ 1- 0< 1-        ( the <nul> word..)    while 2dup s" [if]" s=                   (  ..is at e.o.l. )     if 2dup s" [else]" s=                                            if 2dup s" [endif]" s=                                           if s" [then]" s= else or 0= endif 0= if 1- endif               else 2drop 1- dup if 1+ endif endif                            else 2drop 1+ endif -dup 0= -exit                              repeat 2drop refill                                            0= until drop ;                               immediate                                                                       : [if] -exit [_] [else] ;                       immediate       : [then] ;  immediate           : [endif] ;     immediate                                                           -->         ans definitions ( environmental queries )                       environment definitions                                                                                                         1 constant CORE                                                 1 constant CORE-EXT                                                                                                             1 constant BLOCK                    ( F4 kernel )               1 constant BLOCK-EXT                ( F4 kernel )                                                                               1 constant DOUBLE                                               1 constant DOUBLE-EXT                                                                                                                                                                   -->     \ 0 constant EXCEPTION              ( fig style error handl. ok)\ 0 constant EXCEPTION-EXT          ( ANS won't be implemented )                                                                ans definitions ( environmental queries )                       environment definitions                                                                                                         1 constant FACILITY                                             1 constant FACILITY-EXT                                                                                                         1 constant FILE                                                 1 constant FILE-EXT                                                                                                             32768 constant #LOCALS          ( i.e. not limited )                                                                    -->     \ 0 constant LOCALS                                             \ 0 constant LOCALS-EXT         ( F4 specific from f4x.scr )    \ 0 constant FLOATING                                           \ 0 constant FLOATING-EXT       ( won't be implemented )        \ 0 constant FLOATING-STACK                                     ans definitions ( environmental queries )                       environment definitions                                                                             blk ? scr ? .s cr           1 constant MEMORY-ALLOC                                                                                                         1 constant TOOLS                                                \ 0 constant TOOLS-EXT                                                                                                          1 constant SEARCH-ORDER         ( different F4 impl superior(?) \ 0 constant SEARCH-ORDER-EXT   ( {lload order}, else useless ) 32768 constant WORDLISTS        ( i.e. not limited )                                                                            1 constant STRING                                                                                                       -->                                                                                                                                     ans definitions ( environmental queries )                       environment definitions                                                                                                 -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \ postponed CORE words, which re-define standard F4 words       ans definitions                                                                                                                 : 2! >r swap r> 2! ;                                            : 2@ 2@ swap ;                                                  : create 0 variable ;   ( cannot exactly be substituted )                               ( w.o. major changes to {does>}, too )                          ( and a separate runtime primitive )    : sign rot rot sign ;                                           : variable 0 variable ; ( zero-initiated variant )              : word word here ;      ( postponed till eof, for xlload )                                                                                                                              -->                                                                     \ NOTE: { create .. does> } still advances pfa by one more cell \       then ANS-4th, parameter field is at { ' new-word 4+ }.  \ postponed CORE-EXT words, which re-define standard F4 words   ans definitions                                                                                                                 : ' forth [_] ' ;                                               : 2>r [_] swap [_] 2>r ;        immediate                       : 2r> [_] 2r> [_] swap ;        immediate                       : 2r  [_] 2r  [_] swap ;        immediate                       : expect 2dup expect drop zcount span ! drop ;                  : tib tib @ ;                                                                                                                   \ SEARCH-ORDER: - because fig ":" stores context := current     : : context @ >r [_] : r> context ! ;                                                                                   -->                                                                                                                                                                                                     \ postponed FILE words which re-define standard F4 words                                                                        w/r constant r/w                                                                                                                                                                        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     --> ************** ANS-FORTH compliance for F4 ************* <--                                                                true flag = 1, convert to ANS-style flag value w. {>flag}.      { ' name } returns the pfa                                      { ' name pfa cfa execute } instead of ANS-4th { ' name execute }                                                                { <builds .. does> } words store 2nd-ary cfa to pfa                   which also applies to F4/ans words by { create .. does> } {>body} applicable to variable etc, but not to {create}d words  which should store the current reference to 'vmem' by               { ... create (vp) @ , ... }                                 before storing any other items, for instance                        { ... does> @ >v ... ; }                                                                                                                                                                                                                                    cr cr                                                           .( *************** ANS-FORTH compliance for F4 ************** ) cr                                                              .( supplied w. {ans} vocabulary, {environment} sub-vocabulary ) cr                                                              .( NOTE that several words conflict w. standard F4 definitions) cr                                                              .(      F4 standard true flag value is 1, convert w. {>flag}  ) cr                                                              .( defined word-sets, )                                            ans definitions ?environment cr                                 scr @ 1- list cr                                                                                                                                                                                                                                             \                  mailto:f4@lxhp.in-berlin.de                  ( : testif ) ans    lload? [if]                                                                                                     1 [if] blk ? scr ? .s [else] ." else:" [then] blk ? scr ? .s    0 [if] blk ? scr ? .s [else] ." else:" [then] blk ? scr ? .s    0 [if] blk ? scr ? .s [else]                                                                 ." else:" [then] blk ? scr ? .s    1 [if] blk ? scr ? .s [else] ." else:"                                                                 [then] blk ? scr ? .s    0 [if]                                                                 blk ? scr ? .s [else]                                                                 ." else:" [then] blk ? scr ? .s    1 [if]                                                                 blk ? scr ? .s [else]                                                                 ." else:" [then] blk ? scr ? .s    ." - 'testif' done - " cr                                                                                                    ( FACILITY-EXT: >time&date                                   )    hidden definitions         if-found >time&date 12 +continue  : >time&date         ( n -- year month day hour minute second )   0 60 m/mod 60 m/mod 24 m/mod          ( sec min days d.rmd  )   2dup 730. d- 1461 m/mod         ( 1968; div 4 years + 1 day )   rot >r d- 365 m/mod drop 1970 +       ( leap days flg, year )   swap -1 0 dy 12 bounds                ( -- s m d' y [ rmd )     do drop 1- swap i c@ - swap over 1- 0< -leave i loop            >rr c@ rot + swap not                 ( -- s i h y d m [ry p)   r> r> swap >r                         ( -- .. d m ry [ p )      not 0=                                                          if dup 2 < 0=                         ( adjust on leap year )    if swap 1+ swap r over + 12 + c@ over >                          if 1+ swap 2- swap endif                                      endif endif rot rdrop ;         -wl >time&date 0= if-true -->                                                                 