--> ************** fig-FORTH MODEL EDITOR  F4 ************** <--                                                                in 'root', always available:                                                                                                        where   ( col blk -- )  display line where error found,                                 enter 'editor' voc.                 editor words:                                                                                                                       #locate ( -- col row )  cursor posn in editted screen           #lead   ( -- a col )    string of current line till cursor      #lag    ( -- a count )  string of current line after cursor     -move   ( line a -- )   copy c/l chars at addr a to line        -text   ( a1 u a2 -- )  find text(a1,u1) after/at address a2    1line   ( -- )          scan curs. line for text @pad           match   ( memaddr count stringaddr count -- flg disp )                                                                      ( Mo 2003-07-21 10:30 )                               6 load ;s                                                                 editting commands:                                                  CLEAR   ( n --)         clear scr n w. blanks                   COPY    ( n1 n2 --)     copy scr n1 to n2                       DELETE  ( n -- )        delete n cols backwards from curs       eh      ( -- )          display help screens or,                        ( text, -- )    help for editor word <text>             FIND    ( -- )          text @pad in current scr                flush   ( -- )          all bufs to disc (F4 kernel)            TILL    ( text, -- )    delete from curs till <text>            TOP     ( -- )          curs to top left                        TRUNCATE ( n -- )       truncate/extend at/till block #n        L       ( -- )          re-list current scr                     L+,     ( -- )          list next scr                           L-      ( -- )          list previous scr                       B       ( -- )          curs back by text len @pad              C       ( text, - )     spread at curs posn, copy <text>        D       ( n -- )        drop line n to pad                      E       ( n -- )        erase w. blanks                         F       ( text, - )     find <text>                             H       ( n -- )        hold line n in pad                      I       ( n -- )        inst pad to line n                      M       ( n -- )        advance curs n cols                     N       ( -- )          find next (re 'f')                      P       ( n, text - )   put <text> to line                      R       ( n -- )        replace line n from pad                 S       ( n -- )        spread, fill w bl-s                     T       ( n -- )        type, sto to pad                        U       ( -- )          "update" and "flush"                    X       ( text, -- )    delete <text>                                                                                       ( ********************  fig-FORTH  MODEL  ******************** )                                                                                     Through the courtesy of                                                                                                          FORTH INTEREST GROUP                                               P. O. BOX 1105                                              SAN CARLOS, CA. 94070                                                                                                                                                                                 RELEASE 1                                                 WITH COMPILER SECURITY                                                  AND                                                     VARIABLE LENGTH NAMES                                                                                              (adapted to F4 for ia-32 pc Linux/ELF, hp'8/2002)              Further distribution must include the above notice.      NOT IMPLEMENTED                                                 EMPTY STACK                                                     DICTIONARY FULL                                                 HAS INCORRECT ADDRESS MODE                                      ISN'T UNIQUE                                                                                                                    DISC RANGE ?                                                    FULL STACK                                                      DISC ERROR !                                                                                                                                                                                                                                                                                                                                                                                                                                                    FORTH INTEREST GROUP     ( F4 hp - SEP/2002 )        MAY 1, 1979(  ERROR MESSAGES  ) -->                                        COMPILATION ONLY, USE IN DEFINITION                             EXECUTION ONLY                                                  CONDITIONALS NOT PAIRED                                         DEFINITION NOT FINISHED                                         IN PROTECTED DICTIONARY                                         USE ONLY WHEN LOADING                                           OFF CURRENT EDITING SCREEN                                      DECLARE VOCABULARY                                                                                                                                                                                                                                                                                                                                                                                                                                              FORTH INTEREST GROUP     ( F4 hp - SEP/2002 )        MAY 1, 1979( ********  fig-FORTH  LINE EDITOR  : load-screen : ********* )                                                                     0 warning !                    ( no messages              )     7 load                                                          1 warning !                    ( messages from screenfile )                                                                 cr ."   for help enter EDITOR EH or, EDITOR HELP editorword" cr                                                                     ;S                                                                                                                                                                                                                                                                                                                          bel pad 400 dr? bchan ch-name cr type ":3: emit cr order vocs cr(             EDITOR WORDS NOT TESTED                    ( F4 )                                                                 ( == by deferred word : edit ===================== : [f] : F4 ) xlload? [f] xlload? [e] xlload !hlp xlload? hlp! hlp!                                                                           forth definitions decimal                                                                                                       ( ------------ terminate if editor already exists ----------- )                                                                 \ 1 if-found eh drop editor ' edit forth dup +@ @ swap 4+ @ -   \  if-true                    -l edit 0= if-true ;s                                                                             ( ----------------------------------------------------------- )  forget eh        ( clean re-start if explicitely LLOADed )      lload  eh                                                                                                                          cr ." ==> " lword print ."  <==" cr                                                                                         ( : eh                       : triad                       F4 ) forth definitions decimal            if-found eh -->                                         if-found triad 1 +continue         : triad dup 3 mod - 3 bounds do [f] i list loop #15 message cr ;                                                                : <eh> >input dr0 empty-buffers 0 triad input> ;                ' <eh> defer eh                 \ preliminary defn of "(eh)"                                                                                                                        -->                                                                                                                                                                                                         \ eh    ( -- )                                                  \   praeliminary help, expecting open file <figed.scr> in dr0.  \   default procedure is a 'headerless' example, which executes \   docol{ >input dr0 empty-buffers 0 triad input> }semis       ( -------------------------------------------------------- F4 ) forth definitions decimal       xlload !hlp                                                                                     xlload? #.                                                      xlload? #?                                                      xlload? u?                                                                                                                      xlload? stg                                                     xlload? ch-name                                                 if-found hlp! hlp!                                                                                                              if-nfound #. : #. 0 10 db. ;                                    if-nfound #? : #? @ #. ;                                        if-nfound u? : u? @ u. ;                                                                                                -->                                                                     ( -------------------------------------------------------- F4 ) forth definitions decimal                                                                                                       if-nfound scr?      : scr? ." S:" scr #? ;                      if-nfound 3drop     : 3drop 2drop  drop ;                       if-nfound 4drop     : 4drop 2drop 2drop ;                                                                                       if-nfound scr@ scr (up) - ucons scr@                            if-nfound r#@  r#  (up) - ucons r#@                             if-nfound fld@ fld (up) - ucons fld@                                                                                    -->                                                                                                                                                                                                                                                                                                                                     ( : c/scr : |c/scr : |b/scr : b/b  : b>b                  F4 )  forth definitions decimal                                                                                                       if-nfound c/scr b/scr c/l * constant c/scr ( chars per screen )                                                                 if-nfound editor vocabulary editor immediate                    editor definitions forth                                                                                                        if-nfound |b/scr b/scr 1- constant |b/scr   ( blocks/scr mask ) if-nfound |c/scr c/scr 1- constant |c/scr   ( cursor posn mask) if-nfound b/b prev @ +buf constant b/b drop ( buf size in mem ) if-nfound b>b    4 cons+ b>b                ( disp to content )                                                                         -->                                                     buf-size: pedantischerweise rattert man +buf soange durch bis   ( |buf0 - bufn| = |n| ) mit +buf args: ( bufn -- buf(n+1) n )   ( : curs : where                                  WFR-79may01 ) editor definitions forth                                        : cursor ascii | emit ;       ( cursor character )                                                                              root definitions forth hex    ( make "where" always available ) : where         ( print screen,line # and image of error line )   cr -dup if                                        forth          dup b/scr /mod dup scr ! ." scr# " decimal                      . [ ", 8 << 8 or ] literal emit .                            if-found ch-name 1K |loc l0 1K dr? bchan ch-name type -1K |loc     cr swap c/l /mod c/l * rot block                               else tib @ 2dup swap type endif + c/l type                      cr here c@ - spaces editor cursor [_] editor quit ;                                                                                   -->                                                                                                                     ( : text : LINE                                   WFR-79may03 ) editor definitions forth decimal                                                                                                : text              ( chr -- ( accept following text to pad  )    here c/l 1+ blanks word here pad c/l 1+ cmove ;                                                                               : LINE              ( relative to scr. leave address of line )    scr @ hidden (line) drop ;                                                                                                                                                            -->                                                                     (  dup |b/scr > 23 ?error             ( 'off editting screen' )                                                                                                                                                                                                                                                                 (                  : #locate : #lead : #lag       WFR-79may03 ) editor definitions forth decimal                                                                                                : #locate r# @ c/l /mod ;     ( leave cursor offset-2, line-1 )                                                                 : #lead                  ( line address-2, offset-1 to cursor )   #locate LINE swap ;                                                                                                           : #lag               ( cursor address-2, count-1 after cursor )   #lead dup >r + c/l r> - ;                                                                                                             -->                                                                                                                                                                                                                                                                                                                     ( line editting commands : -move : H : E : S      WFR-79may03 ) editor definitions forth hex                                                                                                    : -move        ( move in block buffer addr from-2,  line to-1 )   LINE c/l cmove update  ;                                                                                                      : H                               ( hold numbered line at pad )   LINE pad 1+ c/l dup pad c! cmove ;                                                                                            : E LINE c/l blanks update ;       ( erase line-1 with blanks )                                                                 : S dup 1- 0e                    ( spread making line # blank )   do i LINE i 1+ -move -1 +loop E ;    ( limit, first to move )                                                                         -->                                                                                                                     ( line editting cmds  : D : M : T                 WFR-79may03 ) editor definitions forth hex                                                                                                    : D dup H 0f dup rot         ( delete line-1, but hold in pad )   do i 1+ LINE i -move loop E ;                                                                                                 : M          ( move cursor by signed amount-1, print its line )   r# @ + |c/scr and r# ! cr space                                 #lead type cursor #lag type #locate . drop ;                                                                                  : 0M 0 M ;                                                                                                                      : T                     ( type line by #-1,  save also in pad )   dup c/l * r# ! dup h 0M ;                                                                                             -->                                                                     ( : L : L+ : L-           : L : P : i  : TOP       WFR-790105 ) editor definitions forth hex                                    if-found l    : L l 0M ;                                        if-nfound l   : L scr @ list 0M ;            ( re-list screen ) : L+ 1 scr +! L ;                                               : L- -1 scr +! L ;                                                                      warning @  1 warning !                  : R pad 1+ swap -move ;       ( replace on line #-1, from pad )                                                                 : P 1 text R ;                 ( put following text on line-1 )                                                                 : I dup S R ;              ( insert text from pad onto line # )                                                                 : TOP 0 r# ! ;            ( home cursor to top left of screen )                         warning !                       -->                                                                     ( screen editing cmds  : clear : flush : copy     WFR-79apr27 ) editor definitions forth                                                                                                        : CLEAR                            ( clear screen by number-1 )   scr ! b/scr 0 do [f] i e loop ;                                                   if-found flush 3 +continue    ( F4 kernel ) : flush                    ( write all updated blocks to disc )   limit first - b/b /                     ( number of buffers )   0 do $7fffffff buffer drop loop ;                                                                                             : COPY      ( n1 n2 -- )  ( duplicate screen-2, onto screen-1 )   dup CLEAR                                                       b/scr * offset @ + swap b/scr * b/scr over + swap               do dup [f] i block [ 0 b>b ] literal - ! 1+ update loop         drop flush ;                                                                                                          -->     ( double number support  : 2drop : 2dup : 2swap   WFR-80apr24 )                                                         -->     9 +continue         ( test ok: skip 9 lines, jmp to line #12 )  forth definitions                                                   ( operates on 32 bit double numbers or two 16-bit integers ): 2drop drop drop ;                      ( drop double number ) : 2dup over over ;                ( duplicate a double number ) : 2swap rot >r rot r> ; ( bring second double to top of stack )         ( additional: )                                         : 2over >r >r 2dup r> r> 2swap ;     ( copy 2nd double to tos ) : bounds over + swap ;              ( addr count -- till from )                                                                                                                         -->                                                                                                                                                                                                     ( string match for editor  : -text             PM-WFR-80apr25 ) editor definitions forth decimal                                                                                                found? s= if-true   6 +continue                                 : -text           ( address-3, count-2, address-1 -- flg )        swap -dup if    ( leave boolean matched=non-zero, nope=zero )    over + swap    ( neither address may be zero! )                 do dup c@ [f] i c@ - if 0= leave else 1+ endif loop            else drop 0= endif ;                                                              1 +continue                                 : -text over s= 0= ;                                                                                                            : U update flush ;                                                                                                                                                                      -->                                                                     ( string match for editor : match : 1line      PM-WFR-80apr25 )         5 +continue                    ( "match" in F4 kernel ) : match        ( curs rmg-bytes string count -- flg curs-disp )   2over bounds                                                    do 2dup [f] i -text                                              if >r 2drop r> - [f] i swap - 0 swap 0. leave endif            loop 2drop swap 0= swap ;          ( caddr bleft | 0 offset )                                                                 : 1line        ( scan line with cursor for match to pad text, )   #lag pad count match r# +! ;   ( update cursor, ret boolean )                                                                 : scr-eof #locate scr @ b/scr * + c/l * + dr? bchan flen < 0= ;   0 constant (fm)       ( ernum for message if text not found )                                                         -->                                                                                                                                     ( : FIND : DELETE )                                                                                                             : FIND                  ( -- ) ( find text in the entire file )   -2 fld and! scr@ r#@ 0                                          enter begin #lag pad count match                                r#@ + c/scr /mod scr +! r# ! dup 0=/= ( abs ) fld or!           entry scr-eof or until  if-found !r# r#@ !r# scr@ !scr          fld@ 1 and if 2drop exit endif r# ! scr ! (fm) message ;                                                                      : DELETE                     ( backwards at cursor by count-1 )   >r #lag + forth r -              ( save blank fill location )   #lag r minus r# +!                          ( backup cursor )   #lead + swap cmove r> blanks update ; ( fill from end of txt)                                                         -->                                                                                                                                     --> ( string editing commands  : FIND : DELETE    WFR-79mar24 )                                                                         ( -- )    \ if found, cursor @r# at posn after string   : FIND  ( string at pad over full screen range, else message. )   begin |c/scr r# @ <                                              if top pad here c/l 1+ cmove 0 message exit endif 1line        until ;                                                                                                                       : DELETE                     ( backwards at cursor by count-1 )   >r #lag + forth r -              ( save blank fill location )   #lag r minus r# +!                          ( backup cursor )   #lead + swap cmove                                              r> blanks update ;                  ( fill from end of text )         -->                                                                                                                                                                                     ( string editor commands  : N : F : B : X         WFR-79mar24 ) editor definitions forth decimal                                                                                                : N FIND 0M ;          ( find next occurance of previous text )                                                                 : F 1 text N ;             ( find occurance of following text )                                                                 : B pad c@ minus M ;           ( backup cursor by text in pad )                                                                 : X 1 text FIND pad c@ DELETE 0M ;    ( delete following text )                                                                                                                         -->                                                                                                                                                                                                                                                                     ( extend/truncate file       : TRUNCATE         hp,2003-02-25 )                                                                 : TRUNCATE      ( +n -- )   ( max flen 2.097.151 screens )        dup 0< if drop exit endif 1+                                    b/scr * c/l * dr? bchan ch-id sp@ sys ftruncate                 dup -4096 u< if 4drop exit endif message 3drop ;                                                                                                                                      -->                                                                                                                                                                                                                                                                                                                                     \ TRUNCATE      ( n -- )                                        \   truncate current screenfile at end of screen no. n or,      \   extend & erase (fill w. <nul>-s) till end of screen no. n.  ( string editor commands  : till : c              WFR-79mar23 )                                                                 : TILL       ( delete on cursor line, from cursor to text end )   #lead + 1 text 1line 0= 0 ?error                                #lead + swap - DELETE 0M ;                                                                                                    : C         ( spread at cursor and copy in the following text )   1 text pad count #lag rot over min >r                           forth r r# +!                                 ( bump cursor )   r - >r                                      ( chars to save )   dup here r cmove                  ( from old cursor to here )   here #lead + r> cmove             ( here to cursor location )   r> cmove update                         ( pad to old cursor )   0M ;                                     ( look at new line )                                                         -->                                                                     ( : help : (eh)                                          ( F4 ) hidden definitions decimal                                      pad 4K dr? bchan ch-name dup stg efi                                                                                            editor definitions decimal                                      : (eh) ( text, -- ( display help for editor word <text> or all)   efi name w@ 1- >input                                           if here l-find else " F4" l-find sdrop 0 swap endif -dup        if using -dup if list else 1 triad endif 0 endif drop           input> ;                                                                                                                      forth                                   ' (eh) is eh                                                                    -->                                                                     \ eh    ( text, -- ) or ( <enter>, -- )                         \   display help-text from figed.scr by dr0                     ( editor done                                                 ) editor definitions decimal                                                                                                      : [edit] [_] editor depth if dup 0>                               if list endif ;s endif eh ;                                   ' [edit] is edit                                                                                                                ' edit forth definitions defer ed                                                                                       ;s                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( editor done                                                 )                                                                 forth definitions decimal                                       ( ----------------------------------------------------------- ) ( cr eh ." type { forth ed } to entering the line EDITOR" cr  ) ( ----------------------------------------------------------- ) forth definitions decimal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( ---------------------------- eof -------------------------- )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 