--> ======= < F4 memory access hi-level extensions > ====== <--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( ========= < F4 memory access hi-level extensions > ========= )                    6 b/scr * 1+ blk ! 0 in !                                                                                                              <f4m.scr>                                                                                                                  Mo 2003-08-11 22:46                                             Tu 2003-08-12 12:42                                                                                                Copyright (C) 2003 h.-peter recktenwald Berlin                              f4a@lxhp.in-berlin.de                                                                                                             ex f6 <forth.scr>                                                                                                                                                                                                                                                                                        =========== < F4 memory access hi-level extensions > ===========                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                =========== < F4 memory access hi-level extensions > ===========                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                1234567890 ..                                      .. 1234567890              1234567890 ..          .. 1234567890              (  ERROR MESSAGES  ) -->                                        EMPTY STACK                                                     DICTIONARY FULL                                                 HAS INCORRECT ADDRESS MODE                                      ISN'T UNIQUE                                                                                                                    DISC RANGE ?                                                    FULL STACK                                                      DISC ERROR !                                                                                                                                                                                                                                                                                                                                                                                                                                                    F4                                                   SEP 2, 2002(  ERROR MESSAGES  ) -->                                        COMPILATION ONLY, USE IN DEFINITION                             EXECUTION ONLY                                                  CONDITIONALS NOT PAIRED                                         DEFINITION NOT FINISHED                                         IN PROTECTED DICTIONARY                                         USE ONLY WHEN LOADING                                           OFF CURRENT EDITING SCREEN                                      DECLARE VOCABULARY                                                                                                                                                                                                                                                                                                                                                                                                                                              F4                                                   SEP 2, 2002( ========= < F4 memory access hi-level extensions > ========= )                                                                               xlload !hlp ( f4x source for "help" )            if-nfound vp      xlload vp                                     if-nfound debug   xlload debug                                  if-nfound abort"  xlload abort"                                                hlp!        ( this file to "help" chain )        if-nfound heapmem lload heapmem                                 if-nfound array   lload array                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( ========= < F4 memory access hi-level extensions > ========= )                                                                lload syshnd                                                    lload >link                                                     lload link>                                                     lload sysheap                                                   lload heap-len                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( ======================================== : dd-head : syshnd ) linux definitions decimal    if-found dd-aclos 12 +continue                                  ( QDOS style, devices, sysvari   ) 0     : dd-lxint ; immediate ( : dd-lxint timer int lnk, i2lst) 4 dd-lxint cons+   dd-axint  ( : dd-axint timer int exec wa   ) 4 dd-axint cons+   dd-lpoll  ( : dd-lpoll polled int lk, plist) 4 dd-lpoll cons+   dd-apoll                                     4 dd-apoll cons+   dd-lschd  ( : dd-lschd scheduled int, shlst) 4 dd-lschd cons+   dd-aschd                                     4 dd-aschd cons+   dd-lio    ( : dd-lio dir. device list lk   ) 4 dd-lio   cons+   dd-aio    ( : dd-aio i/o execution cfa     ) 4 dd-aio   cons+   dd-aopen  ( : dd-aopen resource allocation ) 4 dd-aopen cons+   dd-aclos  ( : dd-aclos resource de-alloc   ) 4 dd-aclos cons+   dd-head   ( : dd-head min dir-dev header sz)                                                                                                      -l dd-head 0= if-true -->  ( ======================================== : sd-head   syshnd ) linux definitions decimal    if-found sd-close 12 +continue     ( QDOS style, devices, sysvari                                ) ( simple devices w/o interrupt hnd:                           )                   : sd-next ; immediate ( simple dev link     ) 4 sd-next   cons+   sd-inout ( : sd-inout basic r/w routine   ) 4 sd-inout  cons+   sd-open  ( : sd-open resource allocation  ) 4 sd-open   cons+   sd-close ( : sd-close resource dealloc    ) 4 sd-close  cons+   sd-head  ( : sd-head specific handler data)                                                                                                                                                                                                                                                                                                                                                                                                                                      -l sd-head 0= if-true -->  ( ========================================== : qsysv   syshnd ) linux definitions decimal    if-found sv-cheap 12 +continue                                  ( : devhnd handlers linkage base ) 0. 2variable devhnd vp 1K 8- vallot >v 1K erase                 : sv-i2lst  devhnd      ;    ( periodic timer int  )            : sv-phlist devhnd 8+   ;    ( polled interrupt    )            : sv-shlst  devhnd 16 + ;    ( scheduled interrupts)            : sv-drlst  devhnd 24 + ;    ( simple devices      )            : sv-ddlst  devhnd 32 + ;    ( dir-devices         )                                                                            : sv-cheap  devhnd 40 + ;    ( common heap link    )            : sv-chpfr  devhnd 44 + ;    ( c.heap free space   )                                                                            \ offset words becase base address may vary w. vmem relocation                                                                                                                                  ( =========================================== : >link   link> ) forth definitions decimal                   if-found >link ;s                                                                   : >link         ( p a -- )          ( link p into chain at a )    2dup @ swap >v ! ! ;                                                                                                          : ?lk   ( a -- )                    ( display link chain at a)    enter begin >v dup 16 b. entry @ dup 16 b. -dup 0= until ;                                                            -->     \ >link ( p a -- )                                              \   append linked list item by ptr p wrt vmem to chain          \   beginning at address a.                                     \                          .-<- +vb <-.     .-<- +vb <-.        \   a0:base address[p0]    a1[p1] a2[p2] .. an[pn]  am[pm]      \                    |            `-<-- +vb <--'    |           \                    `------>------------------>----'+vb        ( == vmem linked list =======================   >link : link> ) forth definitions decimal                    if-found link> ;s                                                                  : -lk           ( p a -- a' p 0|1 ) ( find previous link )        enter begin @ >v                                                entry 2dup @ = over @ 0= or until 2dup @ =/= ;                                                                                : link>         ( p a -- 0|xx )     ( unlk p from chain at a )    dup @ 0= if or exit endif         ( =/= 0 if empty chain   )    -lk if or exit endif swap dup if >v @ endif swap ! 0 ;                                                                                                                                                                                                        \ link>         ( p a -- flg )                                  \   unlink vmem block pointed to by p wrt vmem from linked list \   which begins at address a; ret flg =/= 0 on error, else 0.  ( ========================= : alchp : rechp ======= : sysheap ) linux definitions decimal               if-found hp-hed -->                                                                     lload sd-head ( QDOS-style basic system memory de-/allocation )                                                                 ( common heap memory system header; 32-bit items, single cells)                                                                 : hp-len ; immediate     ( block size in bytes                ) ' 4+      palias hp-drv  ( associated device handler          ) ' 8+      palias hp-own  ( owner job process id               ) 0 hp-own                                                         4+ dup   cons+  hp-lnk  ( heap-list linkage                  )  4+       cons+  hp-hed  ( end of heap-mem system header      )                                                                                                                         -->                                                                     ( =========================   alchp   rechp =======   sysheap ) linux definitions decimal                if-found heapdev -->                                                                   0 hp-lnk  minus cons+ lk>hed   ( convert link to header addr  ) 0 hp-hed  minus cons+ hp>hed   ( ptr to heap header beginning ) 0 hp>hed hp-drv cons+ hp>hnd   ( ptr to dealloc routine cfa   )                                                                 (vp) @ 0 variable heapdev sd-head (vp) ! ( prepare handler blk)                                                                                                                         -->                                                                                                                                                                                                                                                                                                                                                                                                     ( =========================   alchp   rechp =======   sysheap ) linux definitions decimal if-found mmalchp if-found mmalchp -->                                 if-found mmrechp 3 +continue    : mmrechp   ( addr -- er|0 )     ( basic deallocation routine )   dup hp-len @ dup 0= if 2drop -57 endif     ( 'invalid slot' )   swap munmap dup ermax u< 1- and ;          ( w. true flg = 1)                                 if-found mmalchp 4 +continue    : mmalchp   ( size -- addr|er )  ( basic allocation routine   )   mmapa dup ermax u< 0= -exit    ( ret ernum )                    sover hp-len ! sys getpid over hp-own !                         heapdev over hp-drv ! ;        ( ret system memory address  )                                                                 ' mmrechp cfa ' mmalchp cfa 0 heapdev 4+ !+ !+ ! ( handler blk)                                                         -->                                                                     \ hp-head: [ size ][ handler ][ owner id ][ free for flags ]    ( =================================================   sysheap ) linux definitions decimal       if-nfound sv-cheap lload qsysv                                  if-nfound link> lload link>                                     if-found rechp 6 +continue      : rechp     ( addr -- er|0 )     ( per available heap address )   hp>hed dup hp-lnk v> sv-cheap link>                             if drop -43 exit endif                 ( identifier removed )   sys getpid over hp-own @ - if drop -22 endif  ( other owner )   dup hp-drv @ dup if sd-close @ endif                            -dup if execute exit else mmrechp endif ;                                                                             -->                                                                                                                                     \ rechp     ( addr -- 0|ernum)                  linux           \   by addr from {alchp} link memory block back to host system. \   memory block base address unlinked from chain at {sv-cheap}.( =================================================   sysheap ) linux definitions decimal                                                                       if-nfound >link lload >link                                     if-found alchp 2 +continue      : alchp     ( size -- addr|er )                                   hp-hed mmalchp dup hp-lnk v> sv-cheap >link hp-hed ;                                                                                                                                                                                                                                                                                                                                                                                                          \ alchp     ( +n -- addr|ernum )                linux           \   allocate +n bytes of sytem memory, ret address or -ve ernum;\   memory block base address linked into chain at {sv-cheap}.  \   hp-head: [ size ][ handler ][ owner id ][ heapmem-link ]    ( ================================================ : heap-len ) forth definitions decimal lload sysheap  if-found heap-len ;s   hidden definitions                                              : -hp       ( a -- flg )                                          dup 0= -exit hp>hed hp-lnk sv-cheap                             enter begin @ dup if >v 2dup = if 2drop 1 exit endif endif      entry dup 0= until and ;                                                                                                      forth definitions                                               : heap-len                                                        dup -hp 0= if 0and exit endif hp>hed hp-len @ hp>hed ;                                                                        \ -hp       ( a -- flg )                        hidden          \   tf if address a is in the heap-mem linked list, {sv-cheap}. \ heap-len  ( a -- n|0|-er )                    forth           \   size of useable memory of a block allocated w. {alchp}      ( ================================================= : heapmem ) hidden definitions decimal                if-found heapmem ;s                                        if-found heapmem-hed -->    0     variable heap-lk         \ : heap-lk link base           ' 4+   palias   p>h#            \ : p>h# ma -> req. size        ' 8+   palias   p>hs            \ : p>hs ma -> allocated size   16     cons+    p>hb            \ : p>hb ma -> back-ptr         12 dup cons+    p>hl            \ : p>hl ma -> heapmem-link     minus  cons+    hl>p            \ : hl>p heapmem-link -> ma     ' 8-   palias   hs>p            \ : hs>p heapmem-size -> ma     20     cons+    heapmem-hed     \ : heapmem-hed size -> header           --> -------------------------------> p>hb ->-.                 |-> ----------------------> p>hl -->---.      |            ma: 0[ memaddr 4[ #bytes  8[ allocated 12[ link 16[ backp ]20        `---> p>hs --> -- <-- hs>p <---'         |        `-pfa+        `--<----------------------<-- hl>p <---'                ( =================================================   heapmem ) if-nfound heap-len lload heap-len          if-found (lkl) -->                                                                   ' .s defer hfg  \ : hfg  {heapmem} words' "forget"-handler                                                                      ' .s defer (hp) \ : (hp) ( min-lk hmem-lk vmem-bs -- ml hl )                                                                    : (lkl)         \ ( min-lk hmem-lk -- )                           enter begin !csp dup hl>p (hp) @csp                             entry >body 2dup > over 0= or over vb = or                      ?esc or until sdrop v> ;                                                                                              -->     \ F6:  pfa     +4        +6            +8                       \      mmap     (request)   (mmap)       >link    here          \   0[ memaddr 4[ #bytes 8[ allocated 12[ link 16[ backp ]20    \    `-->p>hl          <--'hs>p      <--'hl>p ->-'p>hb          ( =================================================   heapmem ) forth definitions decimal               if-found 4th-heap -->                                                                   : 4th-heap  ( a -- flg )    ( tf if a is a {heapmem} item )       dup 0= -exit hp>hed hp-lnk v> sv-cheap -lk                      if drop 0and exit endif drop >v lk>hed hp-own @ pid@ = ;                                                                                                                              -->                                                                                                                                                                                                                                                                                                                                                                                                     \ 4th-heap  ( a -- flg )                        forth           \   tf if address a is a mmap-ed {heapmem} block                ( =================================================   heapmem ) forth definitions decimal               if-found heap-rmv -->                                                                   : heap-rmv  ( a -- ( dealloc mem at a if allocated by {heapmem)   dup 4th-heap if rechp endif drop ;                                                                                            : clh @ heap-rmv dup v> heap-lk link> drop ; ( lkptr -- lkptr )                                                                 : clchp  0 heap-lk ' clh is (hp) (lkl) drop ;                                                                           -->                                                                     \ heap-rmv  ( a -- )                            forth           \   de-allocate a {heapmem} memory reservation by it's address a\ clchp     ( -- )                              forth           \   de-allocate and unlink from 'heap-lk' chain                 \   all heapmem blocks beginning w. field at link base 'heap-lk'( =================================================   heapmem ) hidden definitions decimal                 if-found (hfg) -->                                                                   : (hfg)                                                           over pfa+ dup@ swap >body    ( .. -- vdisp vptr          )      dup@ heap-rmv                ( -- vd vp heapmem -- vd vp )      p>hl v> heap-lk link> drop vp min is vp ;                                                                                                                                  ' (hfg) is hfg                                                               -->                                       lload debug debug (hfg)                                                                                                                                                                                                     \ (hfg) ( nfa x2 -- x1 x2 )                     hidden          \   forget-handler for {heapmem} words, de-alloc the. rsp. block( =================================================   heapmem ) hidden definitions decimal                  if-found mpfa -->   : (mpfa)    ( min.lk lk.adr va -- ml la pfa | 0 | +nul )          -dup 0= -exit @ 0= -exit                                        dup hl>p @ dup 4th-heap 0= if 2drop exit endif                  pick3 = if -rot 2drop 4+ @ nfa pfa +adr dup endif ;                                                                           : mpfa ' (mpfa) is (hp)  0 swap (lkl) ;                                                                                         forth definitions                                               : heap-pfa heap-lk mpfa -exit 0and ;    ( adr -- ptr|0 )                                                                                                                                -->     \ heap-pfa  ( adr -- pfa|0 )                    forth           \   find definition pfa of a {heapmem}-word by base address     \   of currently allocated memory block.                        ( =================================================   heapmem ) hidden definitions decimal                                                                            if-found hq 2 +continue   : hq -dup 0= -exit dup@ dup ":@ emit 16 b. dup                    if hp>hed hp-len @ endif ":# emit 16 b. p>hb @ nfa id. cr ;                                                                   forth definitions decimal          if-found heap? 2 +continue   : heap? base@ >r hex            ( -- ( display heapmem items  )   ' hq is (hp) 0 heap-lk (lkl) r> base ! drop ;                                                                         -->                                                                     \ hq        ( hm mema -- )                      hidden          \   display heapmem '@:'address, '#:'allocation size, name      \   by defining data linkfield address                          \ heap?     ( -- )                              forth           \   display heapmem items "@:(address) #:(size in bytes) (name)"( =================================================   heapmem ) hidden definitions decimal                   if-found hp> -->                                                                   : -hm       ( pfa -- flg )                                        >body >rr @ >rr 4th-heap r> heap-len r> 8+ @ = and ;                                                                          : hp<       ( pfa -- )                                            >body dup p>hb @ 1- here u< if drop exit endif \ in dictionary  dup@ rechp drop 0 over ! p>hl v> heap-lk link> drop ;                                                                 -->                                                                                                                                     \ -hm       ( pfa -- flg )                      hidden          \   tf if allocated heapmem by defn pointed to by pfa exists    \ hp<       ( pfa -- .. )                       hidden          \   remove heapmem defn & memory if not in dictionary           ( =================================================   heapmem ) hidden definitions decimal                   if-found hp> -->                                                                   : hp> >rr >body dup off p>h# @ alchp dup ermax u<                 0= if message rdrop exit endif                                  r> >body 2dup ! swap hp>hed hp-len @ hp>hed swap p>hs ! ;                                                                     : <hp>                                     ( pfa -- memaddr )     >rr hp< r -hm 0= if r hp> endif r> >body @ ;                                                                                                                                          -->                                                                                                                                     \ <hp>  ( pfa -- a )                            hidden          \   {rechp} if heapmem pfa not in current dictionary space,     \   test whether allocation already done, else {alchp}.         ( =================================================   heapmem ) hidden definitions decimal           if-found hmh 5 +continue                                                                   : hmh   ( n a1 a2 -- )                                            vp dup >v off 4 align to vp                                     here >r vp , 0 v, rot v, 0 v, vp 0 v, swap >link r> v,          last @ pfa [forget] ;                                                                                                                                                                 -->                                                                                                                                                                                                     \ hmh   ( n a1 a2 -- )                          hidden          \   build n bytes' heapmem header linked to chained memory      \   pointers by base address a1 and link @last word to          \   {forget}-handler a1.                                        ( =================================================   heapmem ) forth definitions decimal        if-found heapmem 5 +continue                                                                   : heapmem <builds ' hfg heap-lk hmh does> <hp> ;                                                                                1K heapmem bla vp ' bla nfa pfa+ @ - is heapmem-hed forget bla                                                                                                                                  \ heapmem   ( ccc, n -- ) ( -- a | 0 )                          \   named external memory block n bytes of size, 4K-pages aliged\   allocation when the rsp. {heapmem} word is referred by name.;s                                                                       --> p>hb --> ----------------------> p>hb --> -.        vmem  0[ memaddr 4[ #bytes  8[ allocated 12[ link 16[ backp ]20        `--> p>hs --> -- <-- hs>p <---'         |        `-pfa+         `--> p>hl --> ------------ <-- hl>p <---'               ( == allgemeine array-definitiion =================== : array ) forth definitions decimal                    if-found -dim -->                                                                  lload heapmem lload abort"          hidden definitions                                                                           0 variable array-lk                \ : array-lk array mem link ' (hfg) defer afg                   \ : afg  'forget' handler                                                                   : ?dim abort" ?dim alloc ovf" ;     ( xx flg -- er | xx )       : ?ary abort" ?not an array" ;      ( xx flg -- er | xx )       : -dim -dup 0= -EXIT                ( dn -- n|abort ( alloc ovf)  smudge latest dup id. pfa forget ?dim ;                                                                               -->                                                                                                                                                                                                     ( ===================================================   array ) forth definitions decimal                    if-found dime -->                                                                  : ndim >body heapmem-hed @ ;       ( pfa       -- no.of.dims    : pdim 0max 8* swap >body heapmem-hed + ; ( pfa dim.n -- aptr   : dimn swap pdim 4+ @ ;            ( dim.n pfa -- dimension.size: dimf swap pdim 8+ @ ;            ( dim.n pfa -- fieldsize     : dime dup ndim swap dimn ;        (       pfa -- element.size                                                                                                                                                                                          -->                                                                       0[ memaddr 4[ #bytes  8[ allocated 12[ link 16[ backp ]20      24[ ndims [ dspN|dimN ][ ..|.. ][ dsp1|dim1 ] elmsiz ]                                                                                                                                         ( ===================================================   array ) forth definitions decimal                    if-found ay> -->                                                                   : ay>                                                             >body heapmem-hed @+ over 2@ d0= if d0= exit endif              0 -rot 0 do                                                      rot over 2@ rot sover < over 0< or -4 ?error * rot + swap 8+   loop @ * ;                                                                                                            -->                                                                                                                                                                                                     \ ay>   ( 1st [2nd..nth] pfa -- d.addr | abort err.or           \   calculate disp to requested items for array address;        \   returns minimal allocation base address if not yet {dim}d.  \   for each dim: [ dispN(field size) ][ dimN(no. of fields) ]  ( ===================================================   array ) forth definitions decimal                   if-found array -->                                                                  : array <builds                                                   2dup u* 19 m+ -dim ' afg array-lk hmh                           sdup v, 8* vp over vallot >v swap erase v,                      does> dup <hp> >r ay> r> + ;                                                                                          -->                                                                                                                                                                                                     \ array      ( nd sz ARRAY {name}                               \   define array descriptor for nd dimensions, element size sz. \   sizes & dims product < 2G, limited by available memory.     \   vmem[ mem | #bytes | allocated | link | pfa+ | .. | sz ]    \   array[ 00 | ndims | dspN|dimN | ..|.. | dsp1|dim1 | elmsiz ]( ===================================================   array ) forth definitions decimal                     if-found acr -->                                                                  : acr   ( pfa -- )                ( clr array by pfa )            >body dup@ heap-rmv dup off p>hs off ;                                                                                        \ : (afg) over id. dup . cr .s cr  (hfg) ;                      ' (hfg) is afg                              \ set forget handler                                                                                                                        -->                                                                                                                                                                                                                                                                                                                                                                                                     ( ===================================================   array ) forth definitions decimal                    if-found <ay -->                                                                   : <ay           ( [nth..2nd] 1st pfa2 -- | abort if over-sized    >body >r 1 r heapmem-hed dup@ 8* over + 0 -rot >rr 4-           DO -rot swap 2dup i 2! 1+ u* rot or -8 +LOOP ( dim|disp         swap r> @ u* 3 m+ rot or ?dim r> p>h# ! ;                                                                                     : (dim) dup acr <ay ;                                                                                                   -->                                                                                                                                     \ (dim)     ( dim.n .. dim.1 pfa -- )                           \   clear existing, allocate and set-up new array w. passed dims\ <ay   ( [nth..2nd] 1st pfa2 -- | abort)                       \   sto dimensions, sizes & disps to array data field           ( ===================================================   array ) forth definitions decimal                  if-found ?array -->                                                                  : -array array-lk mpfa -exit 2drop 0 ;                                                                                            1 1 array ?array ' ?array @ forget ?array 0 array-lk !                                                                        : ?array dup@ [ dup minus ] literal + ?ary ; constant [a-cfa]                                                                                                                           -->                                                                                                                                                                                                                                                                                                                                                                                                     ( ===================================================   array ) forth definitions decimal                     if-found dim -->                                                                  : a' -find dup                                                    IF 2drop ENDIF ?array [compile] literal ;     immediate                                                                       : a'clr [_] ' -compile acr ;                    immediate       : dim [_] ' -compile (dim) ;                    immediate                                                                                                                               -->     \ a'    ( ccc, -- pfa|abort )           (i)                     \   as {'} but abort if word ccc is not an {array} definition   \ a'clr ( ccc, -- )                     (i)                     \   clear array memory data                                     \ dim   ( ccc, dim.n ... dim.2 dim.1 -- (i)                     \   clear existing, allocate and set-up new array w. passed dims( ===================================================   array ) hidden definitions decimal                    if-found aq -->                                                                   if-nfound $. : $. 0 16 db. ;                                                                                                    : aq    (  link body -- link .x. ( display array description  )   -dup 0= -exit                                                   cr out off over 4+ @ nfa id. 15 out @ - spaces                  dup@ -dup                                                       if ":@ emit dup $. hp>hed hp-len @ hp>hed ":# emit $. tab       else ." empty" tab tab endif                                    heapmem-hed @+ 2dup 8* + @ ."  size:" . dup ." dims:" .         0 DO @+ 6 .r ": emit @+ . LOOP drop ;                                                                                 -->                                                                                                                                     ( ===================================================   array ) forth definitions decimal         if-found array? 10 +continue                                                                  : dim? dup >body aq ;      ( pfa -- ( query array definition)                                                                   : array? ' aq is (hp) 0 array-lk (lkl) drop ;                                                                                                                                                                                                                                                                                                                                                                                                                   \ dim?     ( pfa -- )                           forth           \   query array definition by pfa                               \ array?   ( -- )                               forth           \   display description of all currently used array definitions ;s ( ================================================   array )                                                                 definition:     #dims size ARRAY {name}                                  erwartet anzahl dimensionen und postengröße im stack.           bereitet alle dimensionen mit größe 0 vor.                                                                             initiierung:    dim.n ... dim.2 dim.1 DIM {name}                         niederwertige dimension @tos.                                   umdefinieren bei löschen der alten daten mit {dim}.                                                                    aufruf:         dim.1 dim.2 ... dim.n {name} -- d.addr                   liefert die speicher-adresse des indizierten datenposte                                                                                                                                \ array ( ccc, #dims size -- ) (X:  .indices. -- addr )         \ dim   ( ccc, dim.n ... dim.2 dim.1 -- (i)                     ;s ( ================================================   array )                                                                 ermitteln der zu einer speicheradresse gehörigen array-pfa:             -array      ( addr  --  array-pfa | 0 )                                                                                 definitionswort z.b. für zweidimensionale 32-bit-integer arrays:        : d2array 2 4 array ;   ( def:          D2ARRAY {name}                                  ( init: dim.2 dim.1 DIM {name}                                                                  grenzen: verfügbarer speicherplatz, produkt der dimensionen mal          postengröße im bereich positiver ganzzahlen (31-bit).           dimensionierung zählt ab 0, anzahl und postengröße ab 1                                                                                                                                \ -array    ( memaddr -- pfa )                                  \   get array pfa by address of allocated memory                ;s ( ================================================   array )                                                                 felddefinitions-daten                                               die worte erwarten die array-pfa wie von {'}                                                                                                                                                \ pdim  ( pfa dim# -- va )                                          rechnet eine array-pfa in den ptr zur felddefinition um.    \ ndim  ( pfa -- n )                                                liefert die (ab 1 zählende) anzahl dimensionen              \ dime  ( pfa -- n )                                                größe eines einzelnen elements in bytes                     \ dimn  ( dimN pfa -- n )                                           wirkliche größe der dimN-ten dimension (dimN ab 0)          \ dimf  ( dimN pfa -- n )                                           anzahl elemente der dimN-ten dimension (dimN ab 0)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          